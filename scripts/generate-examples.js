/**
 * Script pre-build pour lire les fichiers d'exemples et générer
 * un module TypeScript avec le contenu embarqué.
 *
 * Usage: node scripts/generate-examples.js
 */

const fs = require('fs');
const path = require('path');

const EXAMPLES_DIR = path.join(__dirname, '../projects/ds-showcase/src/app/registry/examples');
const OUTPUT_FILE = path.join(__dirname, '../projects/ds-showcase/src/generated/examples-source.generated.ts');

function generateExamples() {
  const examples = {};

  // Vérifier si le dossier examples existe
  if (!fs.existsSync(EXAMPLES_DIR)) {
    console.log(`Dossier examples non trouvé: ${EXAMPLES_DIR}`);
    console.log('Création du fichier vide...');
    writeEmptyOutput();
    return;
  }

  // Parcourir tous les composants
  const components = fs.readdirSync(EXAMPLES_DIR, { withFileTypes: true })
    .filter(d => d.isDirectory());

  for (const component of components) {
    const componentPath = path.join(EXAMPLES_DIR, component.name);
    examples[component.name] = {};

    // Parcourir les démos de chaque composant
    const demos = fs.readdirSync(componentPath, { withFileTypes: true })
      .filter(d => d.isDirectory());

    for (const demo of demos) {
      const demoPath = path.join(componentPath, demo.name);
      const sources = [];

      // Lire les fichiers .ts, .html, .scss
      const files = fs.readdirSync(demoPath);

      for (const file of files) {
        const filePath = path.join(demoPath, file);

        if (file.endsWith('.example.ts') || file.endsWith('.component.ts')) {
          sources.push({
            language: 'typescript',
            filename: file,
            content: fs.readFileSync(filePath, 'utf-8')
          });
        } else if (file.endsWith('.example.html') || file.endsWith('.component.html')) {
          sources.push({
            language: 'html',
            filename: file,
            content: fs.readFileSync(filePath, 'utf-8')
          });
        } else if (file.endsWith('.example.scss') || file.endsWith('.component.scss')) {
          sources.push({
            language: 'scss',
            filename: file,
            content: fs.readFileSync(filePath, 'utf-8')
          });
        }
      }

      if (sources.length > 0) {
        examples[component.name][demo.name] = sources;
      }
    }
  }

  // Générer le fichier TypeScript
  const output = `// AUTO-GENERATED - DO NOT EDIT
// Generated by scripts/generate-examples.js

import { CodeSource } from '../app/registry/types';

export const EXAMPLES_SOURCE: Record<string, Record<string, CodeSource[]>> = ${JSON.stringify(examples, null, 2)};

export function getExampleSources(componentId: string, demoId: string): CodeSource[] {
  return EXAMPLES_SOURCE[componentId]?.[demoId] ?? [];
}
`;

  writeOutput(output);
}

function writeEmptyOutput() {
  const output = `// AUTO-GENERATED - DO NOT EDIT
// Generated by scripts/generate-examples.js

import { CodeSource } from '../app/registry/types';

export const EXAMPLES_SOURCE: Record<string, Record<string, CodeSource[]>> = {};

export function getExampleSources(componentId: string, demoId: string): CodeSource[] {
  return EXAMPLES_SOURCE[componentId]?.[demoId] ?? [];
}
`;
  writeOutput(output);
}

function writeOutput(content) {
  // Créer le dossier si nécessaire
  const dir = path.dirname(OUTPUT_FILE);
  if (!fs.existsSync(dir)) {
    fs.mkdirSync(dir, { recursive: true });
  }

  fs.writeFileSync(OUTPUT_FILE, content);
  console.log(`Generated: ${OUTPUT_FILE}`);
}

generateExamples();
