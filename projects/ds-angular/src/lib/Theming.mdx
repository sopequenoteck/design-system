import { Meta } from '@storybook/blocks';

<Meta title="Guides/Theming" />

# Theming — Guide de personnalisation des thèmes

Ce guide explique comment utiliser, modifier et créer des thèmes personnalisés pour le design system Angular.

---

## 1. Architecture des thèmes

### 1.1 Structure des fichiers

```
projects/ds-angular/src/styles/
├── tokens/
│   ├── _primitives.scss     # Valeurs brutes (couleurs, tailles)
│   ├── _semantic.scss       # Variables sémantiques (composants)
│   └── _tokens.scss         # CSS custom properties :root
└── themes/
    ├── _light.scss          # Thème clair (défaut)
    ├── _dark.scss           # Thème sombre
    └── _custom.scss         # Thème personnalisable
```

### 1.2 Hiérarchie des tokens

```
┌─────────────────────────────────────────────────────────────┐
│  _primitives.scss (SCSS variables)                          │
│  $primary: #3b82f6;                                         │
│  $gray-100: #f3f4f6;                                        │
│  $space-4: 1rem;                                            │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  _semantic.scss (SCSS variables sémantiques)                │
│  $btn-bg-primary: $primary;                                 │
│  $input-border-radius: $radius-2;                           │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  _tokens.scss (CSS custom properties sur :root)             │
│  --color-primary: #{$primary};                              │
│  --btn-bg-primary: #{$btn-bg-primary};                      │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  themes/_light.scss, _dark.scss, _custom.scss               │
│  :root.theme-dark { --background-main: #111827; }           │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. Thèmes disponibles

### 2.1 Thème Light (défaut)

```scss
// themes/_light.scss
:root,
:root.theme-light {
  // Backgrounds
  --background-main: #ffffff;
  --background-subtle: #f9fafb;
  --background-muted: #f3f4f6;

  // Text
  --text-default: #1f2937;
  --text-muted: #6b7280;
  --text-inverted: #ffffff;

  // Borders
  --border-default: #d1d5db;
  --border-hover: #9ca3af;

  // Colors
  --color-primary: #3b82f6;
  --color-primary-hover: #2563eb;
  --color-primary-text: #ffffff;

  // Semantic
  --color-success: #10b981;
  --color-warning: #f59e0b;
  --color-error: #ef4444;
  --color-info: #3b82f6;
}
```

### 2.2 Thème Dark

```scss
// themes/_dark.scss
:root.theme-dark {
  // Backgrounds
  --background-main: #111827;
  --background-subtle: #1f2937;
  --background-muted: #374151;

  // Text
  --text-default: #f9fafb;
  --text-muted: #9ca3af;
  --text-inverted: #111827;

  // Borders
  --border-default: #374151;
  --border-hover: #4b5563;

  // Colors (ajustées pour contraste)
  --color-primary: #60a5fa;
  --color-primary-hover: #93c5fd;
  --color-primary-text: #111827;
}
```

### 2.3 Thème Custom

```scss
// themes/_custom.scss
:root.theme-custom {
  // Surcharger avec vos valeurs
  --color-primary: var(--custom-primary, #8b5cf6);
  --color-primary-hover: var(--custom-primary-hover, #7c3aed);

  --background-main: var(--custom-bg, #faf5ff);
  --text-default: var(--custom-text, #4c1d95);
}
```

---

## 3. Activation des thèmes

### 3.1 Via classe CSS

```typescript
// app.component.ts
export class AppComponent {
  setTheme(theme: 'light' | 'dark' | 'custom'): void {
    document.documentElement.className = `theme-${theme}`;
  }
}
```

### 3.2 Via ThemeService

```typescript
// theme.service.ts
import { Injectable, signal, effect } from '@angular/core';

export type Theme = 'light' | 'dark' | 'custom' | 'system';

@Injectable({ providedIn: 'root' })
export class ThemeService {
  private readonly STORAGE_KEY = 'ds-theme';

  readonly currentTheme = signal<Theme>(this.loadTheme());

  constructor() {
    // Écouter les changements système
    this.setupSystemThemeListener();

    // Appliquer le thème au changement
    effect(() => {
      this.applyTheme(this.currentTheme());
    });
  }

  setTheme(theme: Theme): void {
    this.currentTheme.set(theme);
    localStorage.setItem(this.STORAGE_KEY, theme);
  }

  private loadTheme(): Theme {
    const saved = localStorage.getItem(this.STORAGE_KEY);
    if (saved) return saved as Theme;

    // Détecter préférence système
    if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
      return 'dark';
    }
    return 'light';
  }

  private applyTheme(theme: Theme): void {
    const root = document.documentElement;
    root.classList.remove('theme-light', 'theme-dark', 'theme-custom');

    if (theme === 'system') {
      const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches
        ? 'dark'
        : 'light';
      root.classList.add(`theme-${systemTheme}`);
    } else {
      root.classList.add(`theme-${theme}`);
    }
  }

  private setupSystemThemeListener(): void {
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
      if (this.currentTheme() === 'system') {
        this.applyTheme('system');
      }
    });
  }
}
```

### 3.3 Composant sélecteur de thème

```typescript
// theme-switcher.component.ts
@Component({
  selector: 'app-theme-switcher',
  template: `
    <ds-dropdown label="Thème" [items]="themeOptions" (selectionChange)="onThemeChange($event)">
    </ds-dropdown>
  `,
  standalone: true,
  imports: [DsDropdown],
})
export class ThemeSwitcherComponent {
  private themeService = inject(ThemeService);

  themeOptions = [
    { value: 'light', label: 'Clair' },
    { value: 'dark', label: 'Sombre' },
    { value: 'custom', label: 'Personnalisé' },
    { value: 'system', label: 'Système' },
  ];

  onThemeChange(item: { value: Theme }): void {
    this.themeService.setTheme(item.value);
  }
}
```

---

## 4. Personnalisation des tokens

### 4.1 Surcharge globale

```scss
// Dans votre styles.scss
:root {
  // Surcharger les couleurs primaires
  --color-primary: #8b5cf6;
  --color-primary-hover: #7c3aed;
  --color-primary-text: #ffffff;

  // Surcharger les rayons
  --radius-1: 8px;
  --radius-2: 12px;
  --radius-3: 16px;
}
```

### 4.2 Surcharge par composant

```scss
// Personnaliser un composant spécifique
.my-custom-button {
  --btn-bg-primary: #8b5cf6;
  --btn-border-radius: 9999px;
  --btn-padding-x: 24px;
}
```

```html
<ds-button class="my-custom-button">Bouton personnalisé</ds-button>
```

### 4.3 Thème via CSS variables inline

```html
<div
  style="
    --color-primary: #10b981;
    --color-primary-hover: #059669;
  ">
  <ds-button>Bouton vert</ds-button>
  <ds-input-field label="Champ vert"></ds-input-field>
</div>
```

---

## 5. Créer un thème personnalisé

### 5.1 Template de thème

```scss
// themes/_my-brand.scss
:root.theme-my-brand {
  // =====================
  // COULEURS DE MARQUE
  // =====================
  --color-primary: #your-brand-color;
  --color-primary-hover: #your-brand-hover;
  --color-primary-text: #ffffff;
  --color-primary-subtle: rgba(your-brand-color, 0.1);

  // =====================
  // COULEURS SÉMANTIQUES
  // =====================
  --color-success: #10b981;
  --color-success-subtle: #d1fae5;
  --color-warning: #f59e0b;
  --color-warning-subtle: #fef3c7;
  --color-error: #ef4444;
  --color-error-subtle: #fee2e2;
  --color-info: #3b82f6;
  --color-info-subtle: #dbeafe;

  // =====================
  // BACKGROUNDS
  // =====================
  --background-main: #ffffff;
  --background-subtle: #f9fafb;
  --background-muted: #f3f4f6;
  --background-overlay: rgba(0, 0, 0, 0.5);

  // =====================
  // TEXTE
  // =====================
  --text-default: #1f2937;
  --text-muted: #6b7280;
  --text-inverted: #ffffff;
  --text-link: var(--color-primary);

  // =====================
  // BORDURES
  // =====================
  --border-default: #e5e7eb;
  --border-hover: #d1d5db;
  --border-focus: var(--color-primary);

  // =====================
  // OMBRES
  // =====================
  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);

  // =====================
  // COMPOSANTS
  // =====================
  // Buttons
  --btn-bg-primary: var(--color-primary);
  --btn-bg-primary-hover: var(--color-primary-hover);

  // Inputs
  --input-bg: var(--background-main);
  --input-border-color: var(--border-default);
  --input-focus-border: var(--color-primary);

  // Cards
  --card-bg: var(--background-main);
  --card-border: var(--border-default);
  --card-shadow: var(--shadow-md);
}
```

### 5.2 Importer le thème

```scss
// styles.scss
@import 'ds-angular/styles/tokens/tokens';
@import 'ds-angular/styles/themes/light';
@import 'ds-angular/styles/themes/dark';
@import './themes/my-brand'; // Votre thème
```

---

## 6. Dark mode automatique

### 6.1 Détection système

```typescript
// Détection simple
const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');

if (prefersDark.matches) {
  document.documentElement.classList.add('theme-dark');
}

// Écouter les changements
prefersDark.addEventListener('change', (e) => {
  document.documentElement.classList.toggle('theme-dark', e.matches);
  document.documentElement.classList.toggle('theme-light', !e.matches);
});
```

### 6.2 CSS only (sans JS)

```scss
// Alternative CSS pure avec @media
@media (prefers-color-scheme: dark) {
  :root:not(.theme-light):not(.theme-custom) {
    --background-main: #111827;
    --text-default: #f9fafb;
    // ... autres surcharges dark
  }
}
```

---

## 7. Transitions entre thèmes

### 7.1 Transition douce

```scss
// Dans votre styles.scss global
:root {
  // Transition sur les propriétés de couleur
  transition:
    background-color 0.3s ease,
    color 0.3s ease,
    border-color 0.3s ease;
}

// Désactiver pour reduced motion
@media (prefers-reduced-motion: reduce) {
  :root {
    transition: none;
  }
}
```

### 7.2 Animation de changement

```typescript
// Animation plus élaborée
setTheme(theme: Theme): void {
  const root = document.documentElement;

  // Ajouter classe de transition
  root.classList.add('theme-transitioning');

  // Changer le thème
  root.classList.remove('theme-light', 'theme-dark', 'theme-custom');
  root.classList.add(`theme-${theme}`);

  // Retirer la classe après animation
  setTimeout(() => {
    root.classList.remove('theme-transitioning');
  }, 300);
}
```

```scss
.theme-transitioning * {
  transition:
    background-color 0.3s ease,
    color 0.3s ease,
    border-color 0.3s ease,
    box-shadow 0.3s ease !important;
}
```

---

## 8. Bonnes pratiques

### 8.1 Contraste et accessibilité

```scss
// Toujours vérifier les contrastes
:root.theme-dark {
  // ✅ Bon contraste (ratio 15.8:1)
  --text-default: #f9fafb;
  --background-main: #111827;

  // ❌ Mauvais contraste
  // --text-default: #6b7280; // Ratio 3.7:1 - insuffisant
}
```

### 8.2 Fallbacks

```scss
// Utiliser des fallbacks pour les navigateurs anciens
.ds-button {
  background-color: #3b82f6; // Fallback
  background-color: var(--btn-bg-primary, #3b82f6);
}
```

### 8.3 Organisation des tokens

```scss
// Grouper logiquement
:root {
  // 1. Couleurs de base
  --color-primary: #3b82f6;

  // 2. Couleurs sémantiques
  --color-success: #10b981;

  // 3. Backgrounds
  --background-main: #fff;

  // 4. Texte
  --text-default: #1f2937;

  // 5. Composants (dérivés des précédents)
  --btn-bg: var(--color-primary);
}
```

---

## 9. Debugging

### 9.1 Inspecter les tokens

```javascript
// Console du navigateur
getComputedStyle(document.documentElement)
  .getPropertyValue('--color-primary');

// Lister tous les tokens
const styles = getComputedStyle(document.documentElement);
const tokens = {};
for (const prop of styles) {
  if (prop.startsWith('--')) {
    tokens[prop] = styles.getPropertyValue(prop);
  }
}
console.table(tokens);
```

### 9.2 Visualiser les thèmes dans Storybook

```typescript
// .storybook/preview.ts
export const globalTypes = {
  theme: {
    name: 'Theme',
    description: 'Global theme for components',
    defaultValue: 'light',
    toolbar: {
      icon: 'paintbrush',
      items: [
        { value: 'light', title: 'Light' },
        { value: 'dark', title: 'Dark' },
        { value: 'custom', title: 'Custom' },
      ],
    },
  },
};

export const decorators = [
  (Story, context) => {
    const theme = context.globals.theme;
    document.documentElement.className = `theme-${theme}`;
    return Story();
  },
];
```

---

## 10. Ressources

### 10.1 Références

- [CSS Custom Properties (MDN)](https://developer.mozilla.org/en-US/docs/Web/CSS/Using_CSS_custom_properties)
- [prefers-color-scheme (MDN)](https://developer.mozilla.org/en-US/docs/Web/CSS/@media/prefers-color-scheme)
- [WCAG Contrast Guidelines](https://www.w3.org/WAI/WCAG21/Understanding/contrast-minimum.html)

### 10.2 Outils

- [Contrast Checker](https://webaim.org/resources/contrastchecker/) — Vérifier ratios
- [Coolors](https://coolors.co/) — Générer palettes
- [Color Review](https://color.review/) — Simuler contraste

### 10.3 Liste complète des tokens

| Catégorie | Token | Valeur Light | Valeur Dark |
|-----------|-------|--------------|-------------|
| **Primary** | `--color-primary` | #3b82f6 | #60a5fa |
| | `--color-primary-hover` | #2563eb | #93c5fd |
| **Background** | `--background-main` | #ffffff | #111827 |
| | `--background-subtle` | #f9fafb | #1f2937 |
| **Text** | `--text-default` | #1f2937 | #f9fafb |
| | `--text-muted` | #6b7280 | #9ca3af |
| **Border** | `--border-default` | #d1d5db | #374151 |
| **Success** | `--color-success` | #10b981 | #34d399 |
| **Warning** | `--color-warning` | #f59e0b | #fbbf24 |
| **Error** | `--color-error` | #ef4444 | #f87171 |
