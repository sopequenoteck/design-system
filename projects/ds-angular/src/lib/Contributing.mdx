{/* Contributing.mdx */}
import { Meta } from '@storybook/blocks';

<Meta title="Guides/Contributing" />

# Contribuer à ds-angular

Ce guide décrit comment ajouter des composants, des tokens ou de la documentation dans Storybook.

## Prérequis

- Node 20+ et npm installés.
- Dépendances installées : `npm install` à la racine du repo.
- Storybook accessible via `npm run storybook` (mode preview) ou `npm run build-storybook` (build statique).

## Structure du projet

Le projet est organisé comme suit :

```
design-system/
├── projects/ds-angular/          # Bibliothèque ds-angular
│   ├── src/
│   │   ├── lib/
│   │   │   ├── primitives/       # Composants atomiques (primitive-button, primitive-input, etc.)
│   │   │   ├── components/       # Composants DS (ds-button, ds-modal, etc.)
│   │   │   └── utils/            # Utilitaires (overlay-positions, etc.)
│   │   ├── styles/
│   │   │   ├── tokens/           # _primitives.scss, _semantic.scss, _tokens.scss
│   │   │   └── themes/           # _light.scss, _dark.scss
│   │   └── public/               # Assets statiques (fonts, icons)
├── .storybook/                   # Configuration Storybook
└── package.json                  # Scripts npm
```

### Primitives vs Components

- **Primitives** (`primitives/`) : Composants atomiques sans logique métier
  - Pas de `ControlValueAccessor`
  - Stylisés uniquement via CSS custom properties
  - Exemples : `primitive-button`, `primitive-badge`, `primitive-input`

- **Components** (`components/`) : Composants haut niveau avec logique intégrée
  - Implémentent `ControlValueAccessor` pour les formulaires
  - Utilisent `@angular/cdk` pour les overlays
  - Exemples : `ds-button`, `ds-modal`, `ds-input-field`

## Conventions de nommage

### Composants

- **Prefix** : `ds-` pour les components, `primitive-` pour les primitives
- **Structure fichier** :
  ```
  ds-button/
  ├── ds-button.ts              # Composant principal
  ├── ds-button.scss            # Styles spécifiques
  ├── ds-button.spec.ts         # Tests unitaires
  └── ds-button.stories.ts      # Stories Storybook
  ```

### Tokens

Suivre l'architecture à 3 couches :

1. **Primitifs** (`_primitives.scss`) : `$gray-700`, `$space-4`, `$radius-2`
2. **Sémantiques** (`_semantic.scss`) : `$btn-height-md`, `$input-border-radius`
3. **Globaux** (`_tokens.scss`) : `--color-primary`, `--btn-height-md`
4. **Thématiques** (`themes/*.scss`) : `--background-main`, `--text-default`

### Git

- **Branches** : `feat/nom-feature`, `fix/nom-bug`, `docs/nom-doc`
- **Commits** : Format conventionnel
  ```
  type(scope): description courte

  Corps du commit explicatif si nécessaire
  ```
  Types : `feat`, `fix`, `test`, `docs`, `refactor`, `style`, `chore`, `a11y`

## Workflow de développement

### 1. Créer une branche

```bash
git checkout -b feat/ds-accordion
```

### 2. Développer avec Storybook

```bash
npm run storybook
```

Storybook se lance sur `http://localhost:6006` avec hot-reload.

### 3. Écrire les tests

```bash
# Tests en mode watch
ng test ds-angular

# Tests headless (CI)
npm run test:headless

# Couverture de code
npm run test:coverage
```

**Objectif** : ≥ 85% de couverture pour les components, ≥ 90% pour les primitives.

### 4. Vérifier le build

```bash
npm run build:lib
```

La bibliothèque doit se compiler sans erreurs TypeScript.

### 5. Créer une Pull Request

```bash
git add .
git commit -m "feat(ds-accordion): ajout composant accordion avec tests et stories"
git push origin feat/ds-accordion
```

Puis ouvrir une PR sur GitHub en utilisant le template ci-dessous.

### Template de Pull Request

```markdown
## Description

[Décrivez brièvement les changements apportés]

## Type de changement

- [ ] Nouveau composant
- [ ] Amélioration d'un composant existant
- [ ] Correction de bug
- [ ] Documentation
- [ ] Tokens/Thèmes
- [ ] Breaking change

## Checklist

- [ ] Tests unitaires ajoutés/mis à jour
- [ ] Stories Storybook ajoutées/mises à jour
- [ ] Documentation mise à jour (si applicable)
- [ ] Accessibilité vérifiée (WCAG 2.1 AA)
- [ ] Build réussi (`npm run build:lib`)
- [ ] Tous les tests passent (`npm run test:headless`)

## Screenshots

[Captures d'écran Storybook si le rendu change]

## Breaking Changes

[Listez les breaking changes, ou "Aucun"]
```

---

## Definition of Done

Un composant est considéré comme "terminé" lorsque **tous** les critères suivants sont remplis :

<table style={{width: '100%', borderCollapse: 'collapse', marginBottom: '16px'}}>
  <thead>
    <tr style={{borderBottom: '2px solid var(--border-color, #e5e5e5)'}}>
      <th style={{textAlign: 'left', padding: '12px 16px', fontWeight: 600, width: '180px'}}>Critère</th>
      <th style={{textAlign: 'left', padding: '12px 16px', fontWeight: 600}}>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr style={{borderBottom: '1px solid var(--border-color, #e5e5e5)'}}>
      <td style={{padding: '12px 16px'}}>✅ <strong>Fonctionnel</strong></td>
      <td style={{padding: '12px 16px'}}>Le composant fonctionne correctement dans tous les états (default, hover, focus, disabled, loading)</td>
    </tr>
    <tr style={{borderBottom: '1px solid var(--border-color, #e5e5e5)'}}>
      <td style={{padding: '12px 16px'}}>✅ <strong>Typé</strong></td>
      <td style={{padding: '12px 16px'}}>Tous les inputs/outputs sont typés avec des interfaces/types explicites</td>
    </tr>
    <tr style={{borderBottom: '1px solid var(--border-color, #e5e5e5)'}}>
      <td style={{padding: '12px 16px'}}>✅ <strong>Testé</strong></td>
      <td style={{padding: '12px 16px'}}>Couverture ≥ 85% (components) ou ≥ 90% (primitives), tests navigation clavier inclus</td>
    </tr>
    <tr style={{borderBottom: '1px solid var(--border-color, #e5e5e5)'}}>
      <td style={{padding: '12px 16px'}}>✅ <strong>Documenté</strong></td>
      <td style={{padding: '12px 16px'}}>Story Storybook avec tous les contrôles, descriptions argTypes et exemples d'usage</td>
    </tr>
    <tr style={{borderBottom: '1px solid var(--border-color, #e5e5e5)'}}>
      <td style={{padding: '12px 16px'}}>✅ <strong>Accessible</strong></td>
      <td style={{padding: '12px 16px'}}>Attributs ARIA, navigation clavier, contrastes WCAG 2.1 AA</td>
    </tr>
    <tr style={{borderBottom: '1px solid var(--border-color, #e5e5e5)'}}>
      <td style={{padding: '12px 16px'}}>✅ <strong>Thématisé</strong></td>
      <td style={{padding: '12px 16px'}}>Fonctionne correctement en theme-light, theme-dark et theme-custom</td>
    </tr>
    <tr style={{borderBottom: '1px solid var(--border-color, #e5e5e5)'}}>
      <td style={{padding: '12px 16px'}}>✅ <strong>Exporté</strong></td>
      <td style={{padding: '12px 16px'}}>Composant et types exportés dans <code>components/index.ts</code> ou <code>primitives/index.ts</code></td>
    </tr>
    <tr>
      <td style={{padding: '12px 16px'}}>✅ <strong>Build</strong></td>
      <td style={{padding: '12px 16px'}}>Compilation sans erreurs ni warnings</td>
    </tr>
  </tbody>
</table>

---

## Configuration Storybook

- La génération de docs automatiques est activée (`docs.autodocs = true`) et l'addon `storybook/experimental-addon-test` est chargé pour exploiter `@storybook/test`.
- Les aliases TypeScript `@ds/utils` et `@ds/themes` pointent respectivement vers `projects/ds-angular/src/lib/utils` et `projects/ds-angular/src/styles/themes` (définis dans `tsconfig.json` et repris dans `webpackFinal`).
- Les assets statiques (polices/icônes) sont servis depuis `projects/ds-angular/src/public/fonts` et `projects/ds-angular/src/public/icons` via `staticDirs`.
- L'arborescence des stories est ordonnée pour afficher `Introduction → Tokens → Components → Primitives`.

## Ajouter une page MDX

- Créez un fichier dans `projects/ds-angular/src/lib/*.mdx` avec un titre Storybook via `<Meta title="Ma page" />`.
- Utilisez le format Markdown standard, et préférez des aperçus visuels (swatches, exemples de texte) pour illustrer les tokens.
- Pour les liens internes, utilisez des liens relatifs (ex: `[Tokens](./Tokens)`).

## Ajouter un composant ou une story

<table style={{width: '100%', borderCollapse: 'collapse', marginBottom: '16px'}}>
  <thead>
    <tr style={{borderBottom: '2px solid var(--border-color, #e5e5e5)'}}>
      <th style={{textAlign: 'left', padding: '12px 16px', fontWeight: 600, width: '140px'}}>Étape</th>
      <th style={{textAlign: 'left', padding: '12px 16px', fontWeight: 600}}>Checklist</th>
      <th style={{textAlign: 'left', padding: '12px 16px', fontWeight: 600, width: '220px'}}>Commandes utiles</th>
    </tr>
  </thead>
  <tbody>
    <tr style={{borderBottom: '1px solid var(--border-color, #e5e5e5)'}}>
      <td style={{padding: '12px 16px', fontWeight: 500}}>Créer le composant</td>
      <td style={{padding: '12px 16px'}}>Respecter le préfixe <code>ds-</code>, utiliser <code>input()</code>/<code>output()</code> et les tokens sémantiques</td>
      <td style={{padding: '12px 16px'}}><code>npm run build:lib -- --watch</code></td>
    </tr>
    <tr style={{borderBottom: '1px solid var(--border-color, #e5e5e5)'}}>
      <td style={{padding: '12px 16px', fontWeight: 500}}>Écrire la story</td>
      <td style={{padding: '12px 16px'}}>Documenter les inputs/outputs, ajouter des <code>controls</code> Storybook, vérifier l'accessibilité</td>
      <td style={{padding: '12px 16px'}}><code>npm run storybook</code></td>
    </tr>
    <tr>
      <td style={{padding: '12px 16px', fontWeight: 500}}>Tester</td>
      <td style={{padding: '12px 16px'}}>Couvrir les états (disabled, loading, focus)</td>
      <td style={{padding: '12px 16px'}}><code>npm test</code> ou <code>npm run test:headless</code></td>
    </tr>
  </tbody>
</table>

## Bonnes pratiques

### Accessibilité (WCAG 2.1 niveau AA)

Tous les composants doivent respecter les critères d'accessibilité :

**1. Attributs ARIA**
```typescript
// Exemple : modal
@Component({
  template: `
    <div role="dialog"
         [attr.aria-modal]="true"
         [attr.aria-labelledby]="titleId"
         [attr.aria-describedby]="descId">
      <!-- Contenu -->
    </div>
  `
})
```

**2. Navigation clavier**
- Tab/Shift+Tab : navigation entre éléments focusables
- Espace/Enter : activation des boutons
- Escape : fermeture des overlays
- Arrow keys : navigation dans les listes/dropdowns/tabs

**3. Contraste des couleurs**
- Ratio minimum 4.5:1 pour le texte standard
- Ratio minimum 3:1 pour le texte large (≥18pt)
- Tester avec le thème Dark ET Light

**4. Focus visible**
```scss
// Utiliser le token --focus-ring
button:focus-visible {
  outline: 2px solid var(--focus-ring);
  outline-offset: 2px;
}
```

### Performance

**1. Signals Angular**
```typescript
// Préférer les signals aux getters classiques
readonly variant = input<ButtonVariant>('primary');
readonly isDisabled = computed(() => this.disabled() || this.loading());
```

**2. OnPush Change Detection**
```typescript
@Component({
  changeDetection: ChangeDetectionStrategy.OnPush
})
```

**3. Tree-shaking**
- Utiliser des imports nommés : `import { DsButton } from 'ds-angular'`
- Éviter les `export *` dans les barrel files

**4. Lazy-loading des icônes**
```typescript
// Importer uniquement les icônes nécessaires
import { faCheck, faTimes } from '@fortawesome/free-solid-svg-icons';
```

### Tests

**Checklist complète pour chaque composant** :

- [ ] Création du composant
- [ ] Render des inputs (variant, size, disabled, etc.)
- [ ] Émission des outputs (clicked, valueChange, etc.)
- [ ] États calculés (computed signals)
- [ ] Navigation clavier
- [ ] Attributs ARIA
- [ ] ControlValueAccessor (pour les formulaires)
- [ ] Couverture ≥ 85% (components) ou ≥ 90% (primitives)

Exemple de test :
```typescript
it('should emit clicked event when button is clicked', () => {
  spyOn(component.clicked, 'emit');
  buttonElement.nativeElement.click();
  expect(component.clicked.emit).toHaveBeenCalled();
});
```

## Revue de code

- Préférez des PRs courtes et atomiques (1 fonctionnalité = 1 PR).
- Mettez en avant les tokens touchés et les screenshots Storybook si le rendu change.
- Vérifiez l'impact sur les primitives (`styles/tokens/_primitives.scss`) avant de modifier des valeurs partagées.
- Assurez-vous que tous les tests passent : `npm run test:headless`
- Vérifiez la conformité accessibilité avec l'addon a11y de Storybook
