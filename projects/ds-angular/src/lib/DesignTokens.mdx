import React, { useEffect, useState } from 'react';
import { Meta, Subtitle, Title } from '@storybook/blocks';
import { useGlobals } from '@storybook/preview-api';

const COLOR_TOKENS = [
  { token: '--color-primary', label: 'Action principale' },
  { token: '--color-secondary', label: 'Accent secondaire' },
  { token: '--color-alt', label: 'Alternative' },
  { token: '--background-main', label: 'Fond principal' },
  { token: '--background-panel', label: 'Panneau' },
  { token: '--text-default', label: 'Texte' },
  { token: '--text-muted', label: 'Texte atténué' },
  { token: '--text-disabled', label: 'Texte désactivé' }
];

const TYPO_TOKENS = [
  { token: '--font-family-base', label: 'Police', preview: 'Aa/Öö' },
  { token: '--font-size-2', label: 'Small body', sample: 'Texte secondaire' },
  { token: '--font-size-4', label: 'Body', sample: 'Texte courant' },
  { token: '--font-size-6', label: 'Heading', sample: 'Titre de section' }
];

const SPACING_TOKENS = [
  { token: '--space-1', label: 'Space 1' },
  { token: '--space-2', label: 'Space 2' },
  { token: '--space-3', label: 'Space 3' },
  { token: '--space-4', label: 'Space 4' },
  { token: '--space-6', label: 'Space 6' },
  { token: '--space-8', label: 'Space 8' }
];

const useCssVariables = (tokens) => {
  const [globals] = useGlobals();
  const theme = typeof globals.theme === 'string' ? globals.theme : 'light';
  const [values, setValues] = useState({});

  useEffect(() => {
    const style = getComputedStyle(document.documentElement);
    const next = tokens.reduce((acc, key) => {
      acc[key] = style.getPropertyValue(key).trim();
      return acc;
    }, {});

    setValues(next);
  }, [tokens, theme]);

  return values;
};

const ColorGrid = () => {
  const values = useCssVariables(COLOR_TOKENS.map(({ token }) => token));

  return (
    <div className="token-grid">
      {COLOR_TOKENS.map(({ token, label }) => (
        <div key={token} className="token-card">
          <div className="token-card__header">
            <span className="token-card__label">{label}</span>
            <code className="token-card__code">{token}</code>
          </div>
          <div className="token-card__swatch" style={{ background: values[token] || '#f2f2f2' }} />
          <div className="token-card__value">{values[token]}</div>
        </div>
      ))}
    </div>
  );
};

const TypographyGrid = () => {
  const values = useCssVariables(TYPO_TOKENS.map(({ token }) => token));

  return (
    <div className="token-grid">
      {TYPO_TOKENS.map(({ token, label, sample, preview }) => (
        <div key={token} className="token-card">
          <div className="token-card__header">
            <span className="token-card__label">{label}</span>
            <code className="token-card__code">{token}</code>
          </div>
          <div
            className="token-card__typo"
            style={{
              fontFamily: values['--font-family-base'] || 'inherit',
              fontSize: values[token] || '1rem'
            }}
          >
            {sample || preview || 'Lorem ipsum'}
          </div>
          <div className="token-card__value">
            {label === 'Police' ? values[token] : `${values[token]} / ${values['--font-family-base']}`}
          </div>
        </div>
      ))}
    </div>
  );
};

const SpacingGrid = () => {
  const values = useCssVariables(SPACING_TOKENS.map(({ token }) => token));

  return (
    <div className="token-grid">
      {SPACING_TOKENS.map(({ token, label }) => (
        <div key={token} className="token-card">
          <div className="token-card__header">
            <span className="token-card__label">{label}</span>
            <code className="token-card__code">{token}</code>
          </div>
          <div className="token-card__space" style={{ height: values[token] || '0', background: 'var(--background-panel)' }} />
          <div className="token-card__value">{values[token]}</div>
        </div>
      ))}
    </div>
  );
};

<Meta title="Design Tokens" />

<Title>Design Tokens</Title>
<Subtitle>Palette, typographie et espacements synchronisés avec le sélecteur de thème</Subtitle>

Les sections ci-dessous lisent directement les variables CSS exposées dans `storybook.scss`. Changez le thème dans la toolbar pour voir les tokens s'actualiser en temps réel.

## Couleurs

<ColorGrid />

## Typographie

<TypographyGrid />

## Espacements

<SpacingGrid />

<style>{`
  .token-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: var(--space-3, 1rem);
    margin: var(--space-4, 1.25rem) 0;
  }

  .token-card {
    background: var(--background-panel, #fff);
    border: 1px solid var(--border-subtle, #e5e7eb);
    border-radius: var(--radius-2, 8px);
    padding: var(--space-3, 1rem);
    box-shadow: var(--shadow-1, 0 1px 2px rgba(0, 0, 0, 0.04));
  }

  .token-card__header {
    display: flex;
    flex-direction: column;
    gap: 4px;
    margin-bottom: var(--space-2, 0.5rem);
  }

  .token-card__label {
    font-weight: var(--font-weight-semibold, 600);
    color: var(--text-default, #0f172a);
  }

  .token-card__code {
    font-size: var(--font-size-2, 0.875rem);
    color: var(--text-muted, #475569);
  }

  .token-card__swatch {
    height: 64px;
    border-radius: var(--radius-2, 8px);
    border: 1px solid var(--border-subtle, #e5e7eb);
    margin-bottom: var(--space-2, 0.5rem);
  }

  .token-card__typo {
    padding: var(--space-2, 0.5rem) 0;
    color: var(--text-default, #0f172a);
  }

  .token-card__space {
    width: 100%;
    margin: var(--space-2, 0.5rem) 0;
    border-radius: var(--radius-1, 4px);
    background: linear-gradient(
      90deg,
      color-mix(in srgb, var(--color-secondary, #fbc224) 35%, transparent),
      color-mix(in srgb, var(--color-primary, #7d4bc0) 35%, transparent)
    );
  }

  .token-card__value {
    color: var(--text-muted, #475569);
    font-family: ui-monospace, SFMono-Regular, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
    font-size: var(--font-size-2, 0.875rem);
  }
`}</style>
