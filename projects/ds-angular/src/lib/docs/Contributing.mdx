import { Meta } from '@storybook/blocks';

<Meta title="Guides/Contributing" />

# Guide de contribution

Merci de contribuer au Design System `ds-angular` ! Ce guide vous accompagnera dans le processus de création et d'amélioration des composants.

## Introduction

Le Design System est une bibliothèque Angular 20 standalone conçue pour être réutilisable, accessible et maintenable.

**Avant de contribuer :**
- Lire la documentation Storybook (Introduction, Tokens, Theming)
- Consulter les composants existants pour comprendre les patterns
- Vérifier qu'un composant similaire n'existe pas déjà

## Structure du projet

```
projects/ds-angular/src/lib/
├── primitives/         # Composants atomiques (briques de base)
│   ├── primitive-button/
│   ├── primitive-input/
│   └── ...
├── components/         # Composants DS complets (38 composants)
│   ├── ds-button/
│   ├── ds-modal/
│   ├── ds-table/
│   └── ...
├── utils/              # Services et utilitaires
│   ├── icon-registry.service.ts
│   ├── overlay-positions.ts
│   └── i18n.service.ts
└── styles/
    ├── tokens/         # Design tokens (3 couches)
    └── themes/         # Thèmes light/dark/custom
```

## Créer un nouveau composant

### 1. Checklist des fichiers

Chaque composant DS doit contenir au minimum 5 fichiers :

```
ds-example/
├── ds-example.component.ts        # Logique du composant
├── ds-example.component.html      # Template
├── ds-example.component.scss      # Styles
├── ds-example.component.spec.ts   # Tests unitaires
└── ds-example.stories.ts          # Stories Storybook
```

### 2. Générer le composant

```bash
# Depuis la racine du projet
ng generate component components/ds-example --project=ds-angular --standalone
```

### 3. Structure du composant TypeScript

**Template type :**

```typescript
import { Component, input, output, computed, model } from '@angular/core';
import { CommonModule } from '@angular/common';

export type DsExampleVariant = 'default' | 'primary' | 'secondary';
export type DsExampleSize = 'sm' | 'md' | 'lg';

@Component({
  selector: 'ds-example',
  standalone: true,
  imports: [CommonModule],
  templateUrl: './ds-example.component.html',
  styleUrls: ['./ds-example.component.scss']
})
export class DsExampleComponent {
  // Inputs (signals)
  variant = input<DsExampleVariant>('default');
  size = input<DsExampleSize>('md');
  disabled = input(false);

  // Outputs (signals)
  clicked = output<void>();

  // Computed (signals)
  readonly classes = computed(() => [
    'ds-example',
    `ds-example--${this.variant()}`,
    `ds-example--${this.size()}`,
    this.disabled() ? 'ds-example--disabled' : ''
  ].filter(Boolean).join(' '));

  // Méthodes
  handleClick(): void {
    if (!this.disabled()) {
      this.clicked.emit();
    }
  }
}
```

### 4. Template HTML

**Bonnes pratiques :**
- Utiliser les signals avec `()`
- Ajouter les attributs ARIA appropriés
- Supporter le content projection avec `<ng-content>`

```html
<div [class]="classes()" [attr.aria-disabled]="disabled()">
  <ng-content></ng-content>
</div>
```

### 5. Styles SCSS

**Règles strictes :**
- ❌ Jamais de couleurs hex en dur (`#ff0000`)
- ✅ Toujours utiliser des tokens CSS (`var(--color-error)`)
- ✅ Ajouter des fallbacks pour nouveaux tokens
- ✅ Suivre la méthodologie BEM

```scss
.ds-example {
  // Variables locales (si nécessaire)
  --_padding: var(--example-padding, 1rem);
  --_bg: var(--example-bg, var(--background-main));

  padding: var(--_padding);
  background-color: var(--_bg);
  border-radius: var(--example-radius, var(--radius-2));

  // Variantes
  &--primary {
    background-color: var(--example-bg-primary, var(--color-primary));
    color: var(--example-text-primary, var(--text-on-primary));
  }

  // Tailles
  &--sm {
    padding: var(--example-padding-sm, 0.5rem);
    font-size: var(--font-size-sm);
  }

  &--md {
    padding: var(--example-padding-md, 1rem);
    font-size: var(--font-size-base);
  }

  // États
  &--disabled {
    opacity: var(--disabled-opacity, 0.5);
    cursor: not-allowed;
  }
}
```

### 6. Tests unitaires

**Seuil minimum :** ≥80% de couverture (statements, lines, functions, branches)

```typescript
import { ComponentFixture, TestBed } from '@angular/core/testing';
import { DsExampleComponent } from './ds-example.component';

describe('DsExampleComponent', () => {
  let component: DsExampleComponent;
  let fixture: ComponentFixture<DsExampleComponent>;

  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [DsExampleComponent]
    }).compileComponents();

    fixture = TestBed.createComponent(DsExampleComponent);
    component = fixture.componentInstance;
    fixture.detectChanges();
  });

  it('should create', () => {
    expect(component).toBeTruthy();
  });

  it('should apply variant class', () => {
    component.variant.set('primary');
    fixture.detectChanges();

    const element = fixture.nativeElement;
    expect(element.classList.contains('ds-example--primary')).toBe(true);
  });

  it('should emit clicked event', () => {
    let emitted = false;
    component.clicked.subscribe(() => emitted = true);

    component.handleClick();

    expect(emitted).toBe(true);
  });
});
```

### 7. Stories Storybook

**Couvrir tous les états :**
- Variantes (default, primary, secondary, etc.)
- Tailles (sm, md, lg)
- États (disabled, loading, error, etc.)
- Thèmes (Light, Dark, Custom)

```typescript
import { Meta, StoryObj } from '@storybook/angular';
import { DsExampleComponent } from './ds-example.component';

const meta: Meta<DsExampleComponent> = {
  title: 'Components/DsExample',
  component: DsExampleComponent,
  tags: ['autodocs'],
  argTypes: {
    variant: {
      control: 'select',
      options: ['default', 'primary', 'secondary']
    },
    size: {
      control: 'select',
      options: ['sm', 'md', 'lg']
    }
  }
};

export default meta;
type Story = StoryObj<DsExampleComponent>;

export const Default: Story = {
  args: {
    variant: 'default',
    size: 'md'
  },
  render: (args) => ({
    props: args,
    template: `<ds-example [variant]="variant" [size]="size">Example</ds-example>`
  })
};

export const AllVariants: Story = {
  render: () => ({
    template: `
      <div style="display: flex; gap: 1rem;">
        <ds-example variant="default">Default</ds-example>
        <ds-example variant="primary">Primary</ds-example>
        <ds-example variant="secondary">Secondary</ds-example>
      </div>
    `
  })
};
```

### 8. Exports publics

**Toujours exporter :**
- Le composant principal
- Les types publics (variants, sizes, etc.)

**Fichier `components/index.ts` :**

```typescript
export { DsExampleComponent } from './ds-example/ds-example.component';
export type { DsExampleVariant, DsExampleSize } from './ds-example/ds-example.component';
```

## Conventions de nommage

### Composants

- **Selector** : `ds-{nom}` (ex: `ds-button`, `ds-modal`)
- **Classe CSS racine** : `.ds-{nom}` (ex: `.ds-button`)
- **Classe BEM** : `.ds-{nom}__{élément}--{modificateur}`

### Tokens

- **Primitifs** : `$gray-700`, `$space-4`, `$radius-2`
- **Sémantiques** : `$btn-height-md`, `$input-border-radius`
- **CSS custom properties** : `--color-primary`, `--btn-height-md`
- **Thématiques** : `--background-main`, `--text-default`

### Types

- **Variants** : `DsComponentVariant = 'default' | 'primary' | ...`
- **Sizes** : `DsComponentSize = 'sm' | 'md' | 'lg'`
- **Props** : Interface ou type literal pour les objets complexes

## Pull Request

### 1. Créer une branche

```bash
git checkout -b feat/ds-example-component
```

### 2. Commits conventionnels

Utiliser la [spécification Conventional Commits](https://www.conventionalcommits.org/) :

```bash
git commit -m "feat(ds-example): add new example component with variants"
git commit -m "test(ds-example): add unit tests for all variants"
git commit -m "docs(ds-example): add Storybook stories"
```

**Types de commits :**
- `feat`: Nouvelle fonctionnalité
- `fix`: Correction de bug
- `docs`: Documentation uniquement
- `style`: Formatage (pas de changement de code)
- `refactor`: Refactoring (pas de nouvelle fonctionnalité)
- `test`: Ajout/correction de tests
- `chore`: Tâches de maintenance

### 3. Checklist PR

Avant de soumettre une PR, vérifier :

- ✅ Tous les tests passent (`npm run test:headless`)
- ✅ Couverture ≥80% (`npm run test:coverage`)
- ✅ Build réussit sans erreurs (`npm run build:lib`)
- ✅ Stories Storybook fonctionnelles (`npm run storybook`)
- ✅ Documentation MDX mise à jour si nécessaire
- ✅ `CHANGELOG.md` mis à jour (ou généré via `npm run changelog:generate`)

### 4. Review process

- Les PRs nécessitent une review de l'équipe core
- Les tests CI doivent passer (tests, build, a11y)
- Les tests visuels Chromatic doivent être approuvés

## Release et versioning

Le Design System suit le [Semantic Versioning](https://semver.org/) :

- **MAJOR** (v2.0.0) : Breaking changes
- **MINOR** (v1.1.0) : Nouvelles fonctionnalités rétrocompatibles
- **PATCH** (v1.0.1) : Corrections de bugs

### Publication npm

```bash
# Dry-run (test)
npm run publish:lib:dry-run

# Publication réelle (maintainers uniquement)
npm run publish:lib
```

## Ressources

- [Angular Style Guide](https://angular.dev/style-guide)
- [WCAG 2.1 Guidelines](https://www.w3.org/WAI/WCAG21/quickref/)
- [BEM Methodology](http://getbem.com/)
- [Conventional Commits](https://www.conventionalcommits.org/)
